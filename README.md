# äº‘èšCRM - æ™ºèƒ½å®¢æœç®¡ç†ç³»ç»Ÿ

ğŸš€ é¡¹ç›®æ¦‚è¿°
æ ¸å¿ƒåŠŸèƒ½ä»‹ç»ï¼ˆå¤šè§’è‰²è®¤è¯ã€æ™ºèƒ½å®¢æœã€å¯†é’¥ç®¡ç†ç­‰ï¼‰
æŠ€æœ¯æ¶æ„è¯´æ˜
ç³»ç»Ÿç‰¹è‰²åŠŸèƒ½
ğŸ›  å¼€å‘ç¯å¢ƒæ­å»º
ç¯å¢ƒè¦æ±‚å’Œä¾èµ–å®‰è£…
æœ¬åœ°å¼€å‘é…ç½®
ç¯å¢ƒå˜é‡è®¾ç½®
ğŸŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
æä¾›äº†ä¸‰ç§éƒ¨ç½²æ–¹æ¡ˆï¼š

Dockeréƒ¨ç½²ï¼ˆæ¨èï¼‰- åŒ…å«å®Œæ•´çš„docker-composeé…ç½®
ä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½² - è¯¦ç»†çš„LinuxæœåŠ¡å™¨é…ç½®æ­¥éª¤
äº‘å¹³å°éƒ¨ç½² - Vercelã€Railwayã€AWSç­‰å¹³å°éƒ¨ç½²æŒ‡å—
ğŸ—„ æ•°æ®åº“è®¾è®¡
å®Œæ•´çš„13ä¸ªæ ¸å¿ƒè¡¨ç»“æ„ï¼š

ç”¨æˆ·ç®¡ç†: users, roles, permissions, role_permissions
å¯†é’¥ç³»ç»Ÿ: access_keys, key_usage_logs
å®¢æœèŠå¤©: customers, chat_sessions, chat_messages
åŠŸèƒ½é…ç½®: quick_replies, welcome_messages, agent_settings
æ–‡ä»¶ç®¡ç†: file_uploads
ç³»ç»Ÿé…ç½®: system_settings
ğŸ”§ å…³é”®ç‰¹æ€§
å¯†é’¥ç®¡ç†ç³»ç»Ÿ
naoiodå®‰å…¨æ ¼å¼ï¼š12-16ä½å­—æ¯æ•°å­—ç»„åˆ
48å°æ—¶é»˜è®¤æœ‰æ•ˆæœŸï¼šç¬¦åˆæ‚¨çš„è¦æ±‚
å®æ—¶çŠ¶æ€ç›‘æ§ï¼šè¿‡æœŸæé†’ã€ä½¿ç”¨ç»Ÿè®¡
ç®¡ç†å‘˜ç‰¹æ®Šå¯†é’¥ï¼šadminayi888
å¤šè§’è‰²æƒé™ä½“ç³»
6ä¸ªé¢„å®šä¹‰è§’è‰²ï¼ˆè¶…çº§ç®¡ç†å‘˜åˆ°å®ä¹ å®¢æœï¼‰
ç»†ç²’åº¦æƒé™æ§åˆ¶
åŸºäºçº§åˆ«çš„æƒé™ç»§æ‰¿
æ™ºèƒ½å®¢æœåŠŸèƒ½
è‡ªåŠ¨æ¬¢è¿è¯­ï¼ˆå¤šæ¡æŒ‰åºå‘é€ï¼‰
å¿«æ·å›å¤åˆ†ç±»ç®¡ç†
é»‘åå•ç”¨æˆ·ç®¡ç†
å®æ—¶èŠå¤©å’Œæ–‡ä»¶ä¼ è¾“
ğŸ”’ å®‰å…¨å’Œç›‘æ§
HTTPSé…ç½®
é˜²ç«å¢™è®¾ç½®
æ•°æ®åº“å®‰å…¨
æ—¥å¿—ç®¡ç†
æ€§èƒ½ç›‘æ§
ğŸ“Š è¿ç»´ç®¡ç†
å¤‡ä»½ç­–ç•¥
æ€§èƒ½ä¼˜åŒ–
æ•…éšœæ’é™¤
æ›´æ–°ç»´æŠ¤

å®ç°åŠŸèƒ½æœåŠ¡å±‚å’Œ APIï¼Œä½ éœ€è¦å°†å½“å‰å‰ç«¯åº”ç”¨ä¸­çš„æ¨¡æ‹Ÿæ•°æ®å’Œå†…å­˜çŠ¶æ€ç®¡ç†æ›¿æ¢ä¸ºä¸åç«¯æ•°æ®åº“äº¤äº’çš„å®é™… API è°ƒç”¨ã€‚è¿™å°†æ¶‰åŠè®¾ç½®ä¸€ä¸ªåç«¯æœåŠ¡å™¨ã€å®šä¹‰æ•°æ®åº“æ¨¡å¼ã€åˆ›å»º API ç«¯ç‚¹ï¼Œå¹¶ä¿®æ”¹å‰ç«¯çš„ Zustand å­˜å‚¨ä»¥é€šè¿‡è¿™äº› API è¿›è¡Œæ•°æ®æ“ä½œã€‚

The Plan
è®¾ç½®åç«¯é¡¹ç›®ç»“æ„:

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªæ–°çš„ server æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾åç«¯ä»£ç ã€‚
åœ¨ server æ–‡ä»¶å¤¹å†…åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Node.js é¡¹ç›®ï¼Œå¹¶å®‰è£…å¿…è¦çš„ä¾èµ–ï¼Œä¾‹å¦‚ express ç”¨äºæ„å»º APIï¼Œdotenv ç”¨äºç®¡ç†ç¯å¢ƒå˜é‡ï¼Œä»¥åŠ Supabase å®¢æˆ·ç«¯åº“ã€‚
ï¼ˆå¯é€‰ï¼‰è®¾è®¡ Supabase æ•°æ®åº“æ¨¡å¼:

åœ¨ Supabase ä¸­åˆ›å»ºä»¥ä¸‹è¡¨æ ¼ï¼Œå¹¶å®šä¹‰ç›¸åº”çš„åˆ—å’Œå…³ç³»ï¼š
users: å­˜å‚¨ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜å’Œåå¸­ï¼‰ä¿¡æ¯ï¼ŒåŒ…å« id, name, role_id, avatar_url ç­‰ã€‚
roles: å­˜å‚¨è§’è‰²å®šä¹‰ï¼ŒåŒ…å« id, name, display_name, level, color ç­‰ã€‚
permissions: å­˜å‚¨æƒé™å®šä¹‰ï¼ŒåŒ…å« id, name, display_name, category, description ç­‰ã€‚
role_permissions: å…³è” roles å’Œ permissions è¡¨ï¼Œå®šä¹‰æ¯ä¸ªè§’è‰²æ‹¥æœ‰çš„æƒé™ã€‚
keys: å­˜å‚¨å¯†é’¥ä¿¡æ¯ï¼ŒåŒ…å« id, key_value (naoiodå€¼), type, status, created_at, expires_at, agent_id ç­‰ã€‚
key_usage_logs: å­˜å‚¨å¯†é’¥ä½¿ç”¨æ—¥å¿—ï¼ŒåŒ…å« id, key_id, action, timestamp, ip_address ç­‰ã€‚
agents: å­˜å‚¨åå¸­çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…å« id, user_id, status, current_sessions, max_sessions, skills, groups ç­‰ã€‚
customers: å­˜å‚¨å®¢æˆ·ä¿¡æ¯ï¼ŒåŒ…å« id, name, is_online, last_seen, ip_address ç­‰ã€‚
chat_sessions: å­˜å‚¨èŠå¤©ä¼šè¯ä¿¡æ¯ï¼ŒåŒ…å« id, customer_id, agent_id, status, start_time, last_message_time ç­‰ã€‚
chat_messages: å­˜å‚¨èŠå¤©æ¶ˆæ¯ï¼ŒåŒ…å« id, session_id, sender_id, sender_type, content, type, timestamp ç­‰ã€‚
agent_settings: å­˜å‚¨åå¸­çš„ä¸ªæ€§åŒ–è®¾ç½®ï¼ŒåŒ…å« id, agent_id, auto_welcome_enabled, sound_notifications ç­‰ã€‚
quick_replies: å­˜å‚¨å¿«æ·å›å¤ï¼Œå…³è” agent_settingsã€‚
welcome_messages: å­˜å‚¨æ¬¢è¿è¯­ï¼Œå…³è” agent_settingsã€‚
blacklisted_users: å­˜å‚¨é»‘åå•ç”¨æˆ·ï¼Œå…³è” agent_settingsã€‚
å®ç°åç«¯ API ç«¯ç‚¹:

åœ¨ server æ–‡ä»¶å¤¹å†…åˆ›å»º API è·¯ç”±å’Œæ§åˆ¶å™¨ï¼Œä½¿ç”¨ Supabase å®¢æˆ·ç«¯åº“ä¸æ•°æ®åº“äº¤äº’ã€‚
è®¤è¯ API:
POST /api/auth/login: æ¥æ”¶å¯†é’¥ï¼ˆç®¡ç†å‘˜å¯†é’¥æˆ–åå¸­å¯†é’¥ï¼‰ï¼ŒéªŒè¯å…¶æœ‰æ•ˆæ€§ï¼Œå¹¶è¿”å›ç”¨æˆ·ï¼ˆç®¡ç†å‘˜æˆ–åå¸­ï¼‰ä¿¡æ¯å’Œè®¤è¯ä»¤ç‰Œã€‚
POST /api/auth/validate-key: éªŒè¯åå¸­å¯†é’¥çš„æœ‰æ•ˆæ€§ï¼ˆæ ¼å¼ã€çŠ¶æ€ã€æœ‰æ•ˆæœŸç­‰ï¼‰ã€‚
å¯†é’¥ç®¡ç† API:
GET /api/keys: è·å–æ‰€æœ‰å¯†é’¥åˆ—è¡¨ã€‚
POST /api/keys: ç”Ÿæˆæ–°å¯†é’¥å¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚
PUT /api/keys/:id: æ›´æ–°æŒ‡å®šå¯†é’¥çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚å¤‡æ³¨ã€æœ€å¤§ä½¿ç”¨æ¬¡æ•°ã€è¿‡æœŸæ—¶é—´ï¼‰ã€‚
DELETE /api/keys/:id: åˆ é™¤æŒ‡å®šå¯†é’¥ã€‚
POST /api/keys/:id/suspend: æš‚åœæŒ‡å®šå¯†é’¥ã€‚
POST /api/keys/:id/activate: æ¿€æ´»æŒ‡å®šå¯†é’¥ã€‚
åå¸­ç®¡ç† API:
GET /api/agents: è·å–æ‰€æœ‰åå¸­åˆ—è¡¨ã€‚
POST /api/agents: åˆ›å»ºæ–°åå¸­ã€‚
PUT /api/agents/:id: æ›´æ–°åå¸­ä¿¡æ¯ã€‚
DELETE /api/agents/:id: åˆ é™¤åå¸­ã€‚
PUT /api/agents/:id/status: æ›´æ–°åå¸­çŠ¶æ€ã€‚
èŠå¤©ä¸ä¼šè¯ API:
GET /api/customers: è·å–å®¢æˆ·åˆ—è¡¨ã€‚
GET /api/sessions: è·å–æ‰€æœ‰ä¼šè¯åˆ—è¡¨ã€‚
GET /api/sessions/:id/messages: è·å–æŒ‡å®šä¼šè¯çš„æ¶ˆæ¯è®°å½•ã€‚
POST /api/sessions/:id/messages: å‘é€æ–°æ¶ˆæ¯åˆ°æŒ‡å®šä¼šè¯ã€‚
POST /api/sessions/:id/assign: å°†ä¼šè¯åˆ†é…ç»™æŒ‡å®šåå¸­ã€‚
åå¸­è®¾ç½® API:
GET /api/agent-settings/:agentId: è·å–æŒ‡å®šåå¸­çš„è®¾ç½®ã€‚
PUT /api/agent-settings/:agentId: æ›´æ–°åå¸­è®¾ç½®ï¼ˆä¾‹å¦‚è‡ªåŠ¨å›å¤ã€å£°éŸ³é€šçŸ¥ï¼‰ã€‚
POST /api/agent-settings/:agentId/quick-replies: æ·»åŠ å¿«æ·å›å¤ã€‚
PUT /api/agent-settings/:agentId/quick-replies/:id: æ›´æ–°å¿«æ·å›å¤ã€‚
DELETE /api/agent-settings/:agentId/quick-replies/:id: åˆ é™¤å¿«æ·å›å¤ã€‚
ç±»ä¼¼åœ°ï¼Œä¸ºæ¬¢è¿è¯­ (welcome-messages) å’Œé»‘åå• (blacklist) å®ç° CRUD æ“ä½œã€‚
æ–‡ä»¶å­˜å‚¨ API:
POST /api/upload/file: å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œå°†æ–‡ä»¶å­˜å‚¨åˆ° Supabase Storageï¼Œå¹¶è¿”å›æ–‡ä»¶ URLã€‚
ä¿®æ”¹å‰ç«¯ Zustand å­˜å‚¨ä»¥è°ƒç”¨ API:

src/stores/authStore.ts: ä¿®æ”¹ login æ–¹æ³•ï¼Œä¸å†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œè€Œæ˜¯è°ƒç”¨åç«¯è®¤è¯ API (POST /api/auth/login)ã€‚
src/stores/adminStore.ts:
ä¿®æ”¹ refreshDashboard æ–¹æ³•ï¼Œä»åç«¯ API è·å–ä»ªè¡¨ç›˜æ•°æ®ã€‚
ä¿®æ”¹ generateKey æ–¹æ³•ï¼Œè°ƒç”¨åç«¯ç”Ÿæˆå¯†é’¥ API (POST /api/keys)ã€‚
ä¿®æ”¹ validateKey æ–¹æ³•ï¼Œè°ƒç”¨åç«¯å¯†é’¥éªŒè¯ API (POST /api/auth/validate-key)ã€‚
ä¿®æ”¹ updateKey, deleteKey, suspendKey, activateKey æ–¹æ³•ï¼Œè°ƒç”¨ç›¸åº”çš„åç«¯å¯†é’¥ç®¡ç† APIã€‚
src/stores/agentStore.ts: ä¿®æ”¹ setAgents, addAgent, updateAgent, removeAgent, setAgentStatus ç­‰æ–¹æ³•ï¼Œè°ƒç”¨åç«¯åå¸­ç®¡ç† APIã€‚
src/stores/chatStore.ts:
ä¿®æ”¹ setCustomers, setSessions, addMessage ç­‰æ–¹æ³•ï¼Œä»åç«¯ API è·å–å®¢æˆ·å’Œä¼šè¯æ•°æ®ï¼Œå¹¶å‘é€æ¶ˆæ¯ã€‚
ä¿®æ”¹ setAgentSettings, updateQuickReplies, updateWelcomeMessages, addToBlacklist, removeFromBlacklist ç­‰æ–¹æ³•ï¼Œè°ƒç”¨åç«¯åå¸­è®¾ç½® APIã€‚
src/stores/sessionStore.ts: ä¿®æ”¹ setSessions, addSession, updateSession, assignSession ç­‰æ–¹æ³•ï¼Œè°ƒç”¨åç«¯ä¼šè¯ç®¡ç† APIã€‚
æ›´æ–°æ–‡ä»¶ä¸Šä¼ ç»„ä»¶:

src/components/chat/FileUploadModal.tsx: ä¿®æ”¹ handleUpload å‡½æ•°ï¼Œä¸å†åªæ˜¯æ‰“å°æ–‡ä»¶ä¿¡æ¯ï¼Œè€Œæ˜¯è°ƒç”¨åç«¯æ–‡ä»¶ä¸Šä¼  API (POST /api/upload/file)ã€‚
æ›´æ–° src/components/admin/KeyManagement.tsx ä¸­çš„æ¨¡æ‹Ÿæ•°æ®åˆå§‹åŒ–:

ç§»é™¤ useEffect ä¸­ç”¨äºåˆå§‹åŒ–æ¨¡æ‹Ÿå¯†é’¥æ•°æ®çš„ä»£ç ï¼Œå› ä¸ºæ•°æ®å°†ä»åç«¯è·å–ã€‚
æ›´æ–° src/components/agent/AgentSettings.tsx ä¸­çš„æ¨¡æ‹Ÿå¯†é’¥ä¿¡æ¯:

currentKey çš„æ¨¡æ‹Ÿæ•°æ®ä¹Ÿåº”æ›¿æ¢ä¸ºä»åç«¯è·å–çš„å®é™…åå¸­å¯†é’¥ä¿¡æ¯ã€‚

ä¸ºäº†å®ç°çŸ­é“¾å’ŒäºŒç»´ç çš„æœ‰æ•ˆè®¿é—®ï¼Œå¹¶ç¡®ä¿å®ƒä»¬èƒ½å¤ŸæŒä¹…åŒ–å’Œæ­£ç¡®é‡å®šå‘ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªåç«¯æœåŠ¡æ¥ç®¡ç†çŸ­é“¾æ¥çš„ç”Ÿæˆå’Œè§£æã€‚

ç›®å‰ï¼Œæ‚¨çš„å‰ç«¯ä»£ç  (src/components/agent/AgentSettings.tsx) å·²ç»åŒ…å«äº†ç”ŸæˆçŸ­é“¾ï¼ˆé€šè¿‡éšæœºå­—ç¬¦ä¸²ï¼‰å’Œæ˜¾ç¤ºäºŒç»´ç çš„åŠŸèƒ½ï¼Œå¹¶ä¸” src/App.tsx ä¸­ä¹Ÿé…ç½®äº† /s/:shortId çš„è·¯ç”±ï¼Œå¯ä»¥å°†çŸ­é“¾è¯·æ±‚è·¯ç”±åˆ° UserChatPage ç»„ä»¶ã€‚

ç„¶è€Œï¼Œå½“å‰çŸ­é“¾çš„ç”Ÿæˆæ˜¯çº¯å‰ç«¯æ¨¡æ‹Ÿçš„ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡é¡µé¢åŠ è½½æˆ–åˆ·æ–°æ—¶ï¼ŒçŸ­é“¾éƒ½ä¼šé‡æ–°ç”Ÿæˆï¼Œå¹¶ä¸”è¿™äº›çŸ­é“¾ä¹‹é—´æ²¡æœ‰æŒä¹…çš„æ˜ å°„å…³ç³»ã€‚è¦ä½¿å…¶çœŸæ­£å¯è®¿é—®å’Œæœ‰æ•ˆï¼Œéœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š

The Plan
åˆ›å»ºåç«¯çŸ­é“¾æœåŠ¡:

æ‚¨éœ€è¦æ­å»ºä¸€ä¸ªåç«¯æœåŠ¡ï¼Œæä¾›ä¸¤ä¸ªä¸»è¦çš„APIæ¥å£ï¼š
çŸ­é“¾ç”Ÿæˆæ¥å£: æ¥æ”¶ä¸€ä¸ªé•¿é“¾æ¥ï¼ˆä¾‹å¦‚ï¼Œæ‚¨çš„å®¢æœä¸“å±é“¾æ¥ /chat/:agentIdï¼‰ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„çŸ­IDï¼Œå¹¶å°†è¿™ä¸ªçŸ­IDä¸é•¿é“¾æ¥çš„æ˜ å°„å…³ç³»å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚
çŸ­é“¾é‡å®šå‘æ¥å£: å½“ç”¨æˆ·è®¿é—®çŸ­é“¾æ¥ï¼ˆä¾‹å¦‚ yourdomain.com/s/shortIdï¼‰æ—¶ï¼Œåç«¯æœåŠ¡ä¼šæ ¹æ® shortId åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾å¯¹åº”çš„é•¿é“¾æ¥ï¼Œç„¶åæ‰§è¡ŒHTTP 302é‡å®šå‘åˆ°è¯¥é•¿é“¾æ¥ã€‚
è¿™ä¸ªåç«¯æœåŠ¡å¯ä»¥æ˜¯åŸºäºNode.jsã€Pythonã€Goç­‰ä»»ä½•æ‚¨ç†Ÿæ‚‰çš„è¯­è¨€ï¼Œå¹¶ä½¿ç”¨æ•°æ®åº“ï¼ˆå¦‚PostgreSQL, MongoDBç­‰ï¼‰æ¥å­˜å‚¨æ˜ å°„å…³ç³»ã€‚
ä¿®æ”¹ src/components/agent/AgentSettings.tsx:

æ–‡ä»¶: src/components/agent/AgentSettings.tsx
ä¿®æ”¹å†…å®¹:
å°† generateShortLink å‡½æ•°ä¿®æ”¹ä¸ºè°ƒç”¨æ‚¨åç«¯æœåŠ¡çš„çŸ­é“¾ç”ŸæˆAPIã€‚
å½“APIè¿”å›çŸ­IDå’Œå®Œæ•´çš„çŸ­é“¾æ¥æ—¶ï¼Œæ›´æ–°ç»„ä»¶çš„çŠ¶æ€ shortLinkã€‚
åœ¨è°ƒç”¨APIæ—¶ï¼Œå°†å®¢æœçš„å®Œæ•´é“¾æ¥ (agentLink) ä½œä¸ºå‚æ•°ä¼ é€’ç»™åç«¯ã€‚
åŸå› : è¿™å°†ç¡®ä¿ç”Ÿæˆçš„çŸ­é“¾æ¥æ˜¯æŒä¹…åŒ–çš„ï¼Œå¹¶ä¸”ç”±åç«¯ç®¡ç†å…¶æ˜ å°„å…³ç³»ï¼Œä»è€Œå®ç°çœŸæ­£çš„çŸ­é“¾åŠŸèƒ½ã€‚
é…ç½®åç«¯é‡å®šå‘:

æ–‡ä»¶: (åç«¯æ–‡ä»¶ï¼Œæ­¤å¤„æ— æ³•æä¾›å…·ä½“è·¯å¾„)
ä¿®æ”¹å†…å®¹:
ç¡®ä¿æ‚¨çš„åç«¯æœåŠ¡èƒ½å¤Ÿæ•è·æ‰€æœ‰ /s/:shortId å½¢å¼çš„è¯·æ±‚ã€‚
åœ¨æ¥æ”¶åˆ°è¿™äº›è¯·æ±‚åï¼Œä»URLä¸­æå– shortIdã€‚
ä½¿ç”¨ shortId æŸ¥è¯¢æ•°æ®åº“ï¼Œæ‰¾åˆ°å¯¹åº”çš„é•¿é“¾æ¥ã€‚
æ‰§è¡Œä¸€ä¸ªHTTP 302ï¼ˆä¸´æ—¶é‡å®šå‘ï¼‰åˆ°æŸ¥æ‰¾åˆ°çš„é•¿é“¾æ¥ã€‚
åŸå› : è¿™æ˜¯çŸ­é“¾æ¥åŠŸèƒ½çš„æ ¸å¿ƒï¼Œå®ƒå…è®¸ç”¨æˆ·é€šè¿‡ç®€çŸ­çš„URLè®¿é—®åˆ°å®é™…çš„å®¢æœèŠå¤©é¡µé¢ã€‚
éƒ¨ç½²åç«¯æœåŠ¡:

å°†æ‚¨çš„åç«¯æœåŠ¡éƒ¨ç½²åˆ°ä¸€ä¸ªå¯å…¬å¼€è®¿é—®çš„æœåŠ¡å™¨æˆ–äº‘å¹³å°ä¸Šã€‚
ç¡®ä¿æ‚¨çš„å‰ç«¯åº”ç”¨èƒ½å¤Ÿè®¿é—®åˆ°è¿™ä¸ªåç«¯æœåŠ¡çš„APIæ¥å£ã€‚

### ç¯å¢ƒè¦æ±‚
- Node.js >= 18.0.0
- npm >= 8.0.0 æˆ– yarn >= 1.22.0
- Git

### 1. å…‹éš†é¡¹ç›®
```bash
git clone <repository-url>
cd yunju-crm
```

### 2. å®‰è£…ä¾èµ–
```bash
npm install
# æˆ–
yarn install
```

### 3. ç¯å¢ƒé…ç½®
åˆ›å»º `.env.local` æ–‡ä»¶ï¼š
```env
# åº”ç”¨é…ç½®
VITE_APP_TITLE=äº‘èšCRM
VITE_APP_VERSION=1.0.0
VITE_API_BASE_URL=http://localhost:3001/api

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://username:password@localhost:5432/yunju_crm
REDIS_URL=redis://localhost:6379

# JWTé…ç½®
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=7d

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=image/jpeg,image/png,image/gif,application/pdf,application/zip

# Socket.ioé…ç½®
SOCKET_CORS_ORIGIN=http://localhost:5173
```

### 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
npm run dev
# æˆ–
yarn dev
```

è®¿é—® http://localhost:5173

### 5. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
npm run build
# æˆ–
yarn build
```

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### æ–¹æ¡ˆä¸€ï¼šDockeréƒ¨ç½²ï¼ˆæ¨èï¼‰

#### 1. åˆ›å»º Dockerfile
```dockerfile
# å‰ç«¯æ„å»ºé˜¶æ®µ
FROM node:18-alpine as frontend-build
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine
COPY --from=frontend-build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 2. åˆ›å»º nginx.conf
```nginx
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;
        
        # å¤„ç†å‰ç«¯è·¯ç”±
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        # APIä»£ç†
        location /api/ {
            proxy_pass http://backend:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Socket.ioä»£ç†
        location /socket.io/ {
            proxy_pass http://backend:3001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }
    }
}
```

#### 3. åˆ›å»º docker-compose.yml
```yaml
version: '3.8'

services:
  frontend:
    build: .
    ports:
      - "80:80"
    depends_on:
      - backend
      - database
      - redis
    networks:
      - app-network

  backend:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:password@database:5432/yunju_crm
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - database
      - redis
    networks:
      - app-network

  database:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=yunju_crm
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    networks:
      - app-network

volumes:
  postgres_data:
  redis_data:

networks:
  app-network:
    driver: bridge
```

#### 4. éƒ¨ç½²å‘½ä»¤
```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

### æ–¹æ¡ˆäºŒï¼šä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½²

#### 1. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£…PM2
sudo npm install -g pm2

# å®‰è£…Nginx
sudo apt install nginx -y

# å®‰è£…PostgreSQL
sudo apt install postgresql postgresql-contrib -y

# å®‰è£…Redis
sudo apt install redis-server -y
```

#### 2. æ•°æ®åº“åˆå§‹åŒ–
```bash
# åˆ‡æ¢åˆ°postgresç”¨æˆ·
sudo -u postgres psql

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
CREATE DATABASE yunju_crm;
CREATE USER yunju_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE yunju_crm TO yunju_user;
\q
```

#### 3. åº”ç”¨éƒ¨ç½²
```bash
# å…‹éš†ä»£ç 
git clone <repository-url> /var/www/yunju-crm
cd /var/www/yunju-crm

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºå‰ç«¯
npm run build

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env.production
nano .env.production

# å¯åŠ¨åç«¯æœåŠ¡ï¼ˆå‡è®¾åç«¯åœ¨backendç›®å½•ï¼‰
cd backend
npm install
pm2 start ecosystem.config.js --env production
```

#### 4. Nginxé…ç½®
```bash
# åˆ›å»ºNginxé…ç½®
sudo nano /etc/nginx/sites-available/yunju-crm
```

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/yunju-crm/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /socket.io/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

```bash
# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/yunju-crm /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### æ–¹æ¡ˆä¸‰ï¼šäº‘å¹³å°éƒ¨ç½²

#### Verceléƒ¨ç½²ï¼ˆå‰ç«¯ï¼‰
```bash
# å®‰è£…Vercel CLI
npm i -g vercel

# éƒ¨ç½²
vercel --prod
```

#### Railwayéƒ¨ç½²ï¼ˆå…¨æ ˆï¼‰
1. è¿æ¥GitHubä»“åº“
2. é…ç½®ç¯å¢ƒå˜é‡
3. è‡ªåŠ¨éƒ¨ç½²

#### AWS/é˜¿é‡Œäº‘éƒ¨ç½²
1. åˆ›å»ºEC2/ECSå®ä¾‹
2. é…ç½®å®‰å…¨ç»„
3. æŒ‰ä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½²æµç¨‹æ“ä½œ

## æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE,
    avatar_url TEXT,
    role_id UUID REFERENCES roles(id),
    status VARCHAR(20) DEFAULT 'offline',
    access_key VARCHAR(16) UNIQUE, -- naoiodæ ¼å¼å¯†é’¥
    key_expires_at TIMESTAMP,
    is_online BOOLEAN DEFAULT false,
    last_active_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_users_access_key ON users(access_key);
CREATE INDEX idx_users_role_id ON users(role_id);
CREATE INDEX idx_users_status ON users(status);
```

#### 2. è§’è‰²è¡¨ (roles)
```sql
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    color VARCHAR(7) NOT NULL, -- åå…­è¿›åˆ¶é¢œè‰²
    level INTEGER NOT NULL, -- æƒé™çº§åˆ« 1-100
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆå§‹åŒ–è§’è‰²æ•°æ®
INSERT INTO roles (name, display_name, color, level, description) VALUES
('super_admin', 'è¶…çº§ç®¡ç†å‘˜', '#ff4d4f', 100, 'ç³»ç»Ÿæœ€é«˜æƒé™'),
('admin', 'ç®¡ç†å‘˜', '#fa8c16', 90, 'ç®¡ç†å‘˜æƒé™'),
('supervisor', 'ä¸»ç®¡', '#1890ff', 70, 'å›¢é˜Ÿä¸»ç®¡æƒé™'),
('senior_agent', 'é«˜çº§å®¢æœ', '#52c41a', 50, 'é«˜çº§å®¢æœæƒé™'),
('agent', 'æ™®é€šå®¢æœ', '#722ed1', 30, 'æ™®é€šå®¢æœæƒé™'),
('trainee', 'å®ä¹ å®¢æœ', '#13c2c2', 10, 'å®ä¹ å®¢æœæƒé™');
```

#### 3. æƒé™è¡¨ (permissions)
```sql
CREATE TABLE permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    category VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permissions (
    role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
    permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
    PRIMARY KEY (role_id, permission_id)
);
```

#### 4. å¯†é’¥ç®¡ç†è¡¨ (access_keys)
```sql
CREATE TABLE access_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    key_value VARCHAR(16) UNIQUE NOT NULL, -- naoiodæ ¼å¼å¯†é’¥
    key_type VARCHAR(20) NOT NULL, -- 'agent' æˆ– 'admin'
    status VARCHAR(20) DEFAULT 'active', -- 'active', 'expired', 'suspended'
    user_id UUID REFERENCES users(id),
    created_by UUID REFERENCES users(id),
    expires_at TIMESTAMP NOT NULL,
    max_usage INTEGER, -- æœ€å¤§ä½¿ç”¨æ¬¡æ•°
    usage_count INTEGER DEFAULT 0,
    last_used_at TIMESTAMP,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_access_keys_key_value ON access_keys(key_value);
CREATE INDEX idx_access_keys_user_id ON access_keys(user_id);
CREATE INDEX idx_access_keys_status ON access_keys(status);
CREATE INDEX idx_access_keys_expires_at ON access_keys(expires_at);
```

#### 5. å¯†é’¥ä½¿ç”¨æ—¥å¿—è¡¨ (key_usage_logs)
```sql
CREATE TABLE key_usage_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    key_id UUID REFERENCES access_keys(id),
    user_id UUID REFERENCES users(id),
    action VARCHAR(50) NOT NULL, -- 'login', 'logout', 'session_start', 'session_end', 'heartbeat'
    ip_address INET,
    user_agent TEXT,
    session_id UUID,
    duration INTEGER, -- æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_key_usage_logs_key_id ON key_usage_logs(key_id);
CREATE INDEX idx_key_usage_logs_user_id ON key_usage_logs(user_id);
CREATE INDEX idx_key_usage_logs_created_at ON key_usage_logs(created_at);
```

#### 6. å®¢æˆ·è¡¨ (customers)
```sql
CREATE TABLE customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100),
    email VARCHAR(255),
    avatar_url TEXT,
    phone VARCHAR(20),
    ip_address INET,
    device_info TEXT,
    user_agent TEXT,
    location VARCHAR(255),
    is_online BOOLEAN DEFAULT false,
    is_blacklisted BOOLEAN DEFAULT false,
    has_received_welcome BOOLEAN DEFAULT false,
    last_seen_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_customers_email ON customers(email);
CREATE INDEX idx_customers_is_online ON customers(is_online);
CREATE INDEX idx_customers_is_blacklisted ON customers(is_blacklisted);
```

#### 7. èŠå¤©ä¼šè¯è¡¨ (chat_sessions)
```sql
CREATE TABLE chat_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID REFERENCES customers(id),
    agent_id UUID REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'waiting', -- 'waiting', 'active', 'ended'
    priority VARCHAR(20) DEFAULT 'normal', -- 'low', 'normal', 'high', 'vip'
    source VARCHAR(50) DEFAULT 'web', -- 'web', 'mobile', 'api'
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ended_at TIMESTAMP,
    last_message_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    message_count INTEGER DEFAULT 0,
    satisfaction_rating INTEGER, -- 1-5æ˜Ÿè¯„åˆ†
    welcome_sent BOOLEAN DEFAULT false,
    tags TEXT[], -- ä¼šè¯æ ‡ç­¾
    metadata JSONB, -- é¢å¤–å…ƒæ•°æ®
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_chat_sessions_customer_id ON chat_sessions(customer_id);
CREATE INDEX idx_chat_sessions_agent_id ON chat_sessions(agent_id);
CREATE INDEX idx_chat_sessions_status ON chat_sessions(status);
CREATE INDEX idx_chat_sessions_started_at ON chat_sessions(started_at);
```

#### 8. èŠå¤©æ¶ˆæ¯è¡¨ (chat_messages)
```sql
CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID REFERENCES chat_sessions(id),
    sender_id UUID, -- å¯ä»¥æ˜¯customer_idæˆ–user_id
    sender_type VARCHAR(20) NOT NULL, -- 'customer', 'agent', 'system'
    message_type VARCHAR(20) DEFAULT 'text', -- 'text', 'image', 'file', 'system'
    content TEXT NOT NULL,
    file_url TEXT,
    file_name VARCHAR(255),
    file_size INTEGER,
    file_type VARCHAR(100),
    status VARCHAR(20) DEFAULT 'sent', -- 'sending', 'sent', 'delivered', 'read', 'failed'
    is_welcome_message BOOLEAN DEFAULT false,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_chat_messages_session_id ON chat_messages(session_id);
CREATE INDEX idx_chat_messages_sender_id ON chat_messages(sender_id);
CREATE INDEX idx_chat_messages_created_at ON chat_messages(created_at);
```

#### 9. å¿«æ·å›å¤è¡¨ (quick_replies)
```sql
CREATE TABLE quick_replies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID REFERENCES users(id),
    title VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(50),
    usage_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_quick_replies_agent_id ON quick_replies(agent_id);
CREATE INDEX idx_quick_replies_category ON quick_replies(category);
```

#### 10. æ¬¢è¿è¯­è¡¨ (welcome_messages)
```sql
CREATE TABLE welcome_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID REFERENCES users(id),
    content TEXT NOT NULL,
    display_order INTEGER NOT NULL,
    is_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_welcome_messages_agent_id ON welcome_messages(agent_id);
CREATE INDEX idx_welcome_messages_order ON welcome_messages(display_order);
```

#### 11. åå¸­è®¾ç½®è¡¨ (agent_settings)
```sql
CREATE TABLE agent_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID UNIQUE REFERENCES users(id),
    auto_welcome_enabled BOOLEAN DEFAULT true,
    sound_notifications BOOLEAN DEFAULT true,
    auto_reply_enabled BOOLEAN DEFAULT false,
    max_concurrent_sessions INTEGER DEFAULT 5,
    working_hours JSONB, -- å·¥ä½œæ—¶é—´é…ç½®
    break_duration INTEGER DEFAULT 15, -- ä¼‘æ¯æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 12. æ–‡ä»¶ä¸Šä¼ è¡¨ (file_uploads)
```sql
CREATE TABLE file_uploads (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    original_name VARCHAR(255) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_path TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    file_type VARCHAR(100) NOT NULL,
    uploaded_by UUID REFERENCES users(id),
    session_id UUID REFERENCES chat_sessions(id),
    status VARCHAR(20) DEFAULT 'uploaded', -- 'uploading', 'uploaded', 'failed'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_file_uploads_session_id ON file_uploads(session_id);
CREATE INDEX idx_file_uploads_uploaded_by ON file_uploads(uploaded_by);
```

#### 13. ç³»ç»Ÿé…ç½®è¡¨ (system_settings)
```sql
CREATE TABLE system_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT,
    description TEXT,
    category VARCHAR(50),
    is_public BOOLEAN DEFAULT false, -- æ˜¯å¦å¯ä»¥è¢«å‰ç«¯è®¿é—®
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆå§‹åŒ–ç³»ç»Ÿé…ç½®
INSERT INTO system_settings (key, value, description, category) VALUES
('key_default_validity_hours', '48', 'å¯†é’¥é»˜è®¤æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰', 'security'),
('max_sessions_per_agent', '5', 'æ¯ä¸ªåå¸­æœ€å¤§å¹¶å‘ä¼šè¯æ•°', 'performance'),
('auto_assignment_enabled', 'true', 'æ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆ†é…', 'assignment'),
('welcome_message_delay', '1000', 'æ¬¢è¿è¯­å‘é€é—´éš”ï¼ˆæ¯«ç§’ï¼‰', 'chat');
```

### æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

åˆ›å»º `database/init.sql`ï¼š

```sql
-- å¯ç”¨UUIDæ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- åˆ›å»ºæ‰€æœ‰è¡¨ï¼ˆæŒ‰ä¸Šè¿°ç»“æ„ï¼‰
-- ... è¿™é‡ŒåŒ…å«æ‰€æœ‰è¡¨çš„åˆ›å»ºè¯­å¥ ...

-- ä¸ºéœ€è¦çš„è¡¨æ·»åŠ æ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_access_keys_updated_at BEFORE UPDATE ON access_keys
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ... å…¶ä»–è¡¨çš„è§¦å‘å™¨ ...

-- åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦å·
INSERT INTO users (name, email, role_id, access_key, key_expires_at, status) 
SELECT 
    'ç³»ç»Ÿç®¡ç†å‘˜', 
    'admin@system.com', 
    r.id, 
    'adminayi888', 
    CURRENT_TIMESTAMP + INTERVAL '10 years',
    'online'
FROM roles r WHERE r.name = 'super_admin';
```

## ç¯å¢ƒå˜é‡é…ç½®

### å¼€å‘ç¯å¢ƒ (.env.local)
```env
# åº”ç”¨åŸºç¡€é…ç½®
VITE_APP_TITLE=äº‘èšCRMå¼€å‘ç¯å¢ƒ
VITE_APP_VERSION=1.0.0-dev
VITE_API_BASE_URL=http://localhost:3001/api
VITE_SOCKET_URL=http://localhost:3001

# å¼€å‘æ¨¡å¼é…ç½®
VITE_DEV_MODE=true
VITE_DEBUG_ENABLED=true
```

### ç”Ÿäº§ç¯å¢ƒ (.env.production)
```env
# åº”ç”¨åŸºç¡€é…ç½®
VITE_APP_TITLE=äº‘èšCRM
VITE_APP_VERSION=1.0.0
VITE_API_BASE_URL=https://api.yourdomain.com/api
VITE_SOCKET_URL=https://api.yourdomain.com

# ç”Ÿäº§æ¨¡å¼é…ç½®
VITE_DEV_MODE=false
VITE_DEBUG_ENABLED=false
```

## ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨ç›‘æ§
- ä½¿ç”¨PM2è¿›è¡Œè¿›ç¨‹ç›‘æ§
- é›†æˆSentryè¿›è¡Œé”™è¯¯è¿½è¸ª
- ä½¿ç”¨Prometheus + Grafanaè¿›è¡Œæ€§èƒ½ç›‘æ§

### 2. æ—¥å¿—ç®¡ç†
```javascript
// æ—¥å¿—é…ç½®ç¤ºä¾‹
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});
```

## å®‰å…¨é…ç½®

### 1. HTTPSé…ç½®
```bash
# ä½¿ç”¨Let's Encryptè·å–SSLè¯ä¹¦
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

### 2. é˜²ç«å¢™é…ç½®
```bash
# UFWé˜²ç«å¢™é…ç½®
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

### 3. æ•°æ®åº“å®‰å…¨
```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER readonly_user WITH PASSWORD 'readonly_password';
GRANT CONNECT ON DATABASE yunju_crm TO readonly_user;
GRANT USAGE ON SCHEMA public TO readonly_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;
```

## å¤‡ä»½ç­–ç•¥

### 1. æ•°æ®åº“å¤‡ä»½
```bash
#!/bin/bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬
BACKUP_DIR="/var/backups/yunju-crm"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="yunju_crm"

mkdir -p $BACKUP_DIR

# åˆ›å»ºå¤‡ä»½
pg_dump $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_DIR/backup_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete
```

### 2. æ–‡ä»¶å¤‡ä»½
```bash
#!/bin/bash
# æ–‡ä»¶å¤‡ä»½è„šæœ¬
rsync -av --delete /var/www/yunju-crm/ /backup/yunju-crm/
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å‰ç«¯ä¼˜åŒ–
- ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½
- å›¾ç‰‡å‹ç¼©å’ŒCDN
- ç¼“å­˜ç­–ç•¥
- Bundleåˆ†æ

### 2. åç«¯ä¼˜åŒ–
- æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- Redisç¼“å­˜
- APIå“åº”å‹ç¼©
- è¿æ¥æ± é…ç½®

### 3. æ•°æ®åº“ä¼˜åŒ–
```sql
-- æ€§èƒ½ç›‘æ§æŸ¥è¯¢
SELECT 
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE tablename IN ('users', 'chat_sessions', 'chat_messages');

-- æ…¢æŸ¥è¯¢åˆ†æ
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å¯†é’¥éªŒè¯å¤±è´¥**
   - æ£€æŸ¥å¯†é’¥æ ¼å¼æ˜¯å¦ä¸ºnaoiodæ ¼å¼
   - ç¡®è®¤å¯†é’¥æœªè¿‡æœŸ
   - éªŒè¯æ•°æ®åº“è¿æ¥

2. **Socketè¿æ¥å¤±è´¥**
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤Socket.ioæœåŠ¡è¿è¡ŒçŠ¶æ€
   - éªŒè¯CORSé…ç½®

3. **æ–‡ä»¶ä¸Šä¼ å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶
   - ç¡®è®¤ä¸Šä¼ ç›®å½•æƒé™
   - éªŒè¯æ–‡ä»¶ç±»å‹é™åˆ¶

### æ—¥å¿—æŸ¥çœ‹
```bash
# PM2æ—¥å¿—
pm2 logs

# Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# ç³»ç»Ÿæ—¥å¿—
sudo journalctl -u nginx -f
```

## æ›´æ–°å’Œç»´æŠ¤

### 1. åº”ç”¨æ›´æ–°
```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# å®‰è£…æ–°ä¾èµ–
npm install

# æ„å»ºæ–°ç‰ˆæœ¬
npm run build

# é‡å¯æœåŠ¡
pm2 restart all
```

### 2. æ•°æ®åº“è¿ç§»
```sql
-- åˆ›å»ºè¿ç§»è„šæœ¬ç¤ºä¾‹
-- migration_001_add_new_column.sql
ALTER TABLE users ADD COLUMN new_field VARCHAR(100);
CREATE INDEX idx_users_new_field ON users(new_field);
```

### 3. ç‰ˆæœ¬ç®¡ç†
- ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶
- åˆ›å»ºå‘å¸ƒæ ‡ç­¾
- ç»´æŠ¤æ›´æ–°æ—¥å¿—

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- æŠ€æœ¯æ”¯æŒï¼štech@yourdomain.com
- æ–‡æ¡£æ›´æ–°ï¼šdocs@yourdomain.com
- ç´§æ€¥è”ç³»ï¼šemergency@yourdomain.com

---

**ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç»´æŠ¤è€…**: äº‘èšCRMå¼€å‘å›¢é˜Ÿ